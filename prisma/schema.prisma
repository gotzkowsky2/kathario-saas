// Kathario SaaS - ë©€í‹°í…Œë„ŒíŠ¸ Prisma ìŠ¤í‚¤ë§ˆ
// ë°”ì‚­ì¹˜í‚¨ ì‹œìŠ¤í…œì„ ê¸°ë°˜ìœ¼ë¡œ í•œ SaaS ì „í™˜

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ğŸ¢ ë©€í‹°í…Œë„ŒíŠ¸ í•µì‹¬ ëª¨ë¸
// ========================================

model Tenant {
  id          String   @id @default(cuid())
  name        String   // "ë°”ì‚­ì¹˜í‚¨", "ë§›ìˆëŠ”ì§‘" ë“±
  domain      String   @unique // "basak", "tasty" ë“± (ì„œë¸Œë„ë©”ì¸ìš©)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // êµ¬ë… ì •ë³´
  subscriptionTier  SubscriptionTier @default(FREE)
  subscriptionStart DateTime         @default(now())
  subscriptionEnd   DateTime?
  
  // ì—°ë½ì²˜ ì •ë³´
  ownerName    String?
  ownerEmail   String?
  ownerPhone   String?
  address      String?
  
  // ì„¤ì •
  settings     Json?    // í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í…€ ì„¤ì •
  
  // ê´€ê³„ - ëª¨ë“  ì£¼ìš” ë°ì´í„°ê°€ í…Œë„ŒíŠ¸ì— ì†í•¨
  employees           Employee[]
  inventoryItems      InventoryItem[]
  checklistTemplates  ChecklistTemplate[]
  checklistInstances  ChecklistInstance[]
  tags               Tag[]
  manuals            Manual[]
  precautions        Precaution[]
  purchaseRequests   PurchaseRequest[]
  notices            Notice[]
  favorites          Favorite[]
  posReports         PosReport[]
  
  @@index([domain])
  @@index([isActive, subscriptionTier])
}

// ========================================
// ğŸ” ì¸ì¦ ë° ì‚¬ìš©ì ê´€ë¦¬
// ========================================

model Employee {
  id                 String              @id @default(cuid())
  tenantId           String              // ğŸ”‘ í…Œë„ŒíŠ¸ ê²©ë¦¬
  employeeId         String              // í…Œë„ŒíŠ¸ ë‚´ì—ì„œ ê³ ìœ í•œ ì§ì› ID
  password           String
  name               String
  email              String?
  phone              String?
  department         String
  position           String
  isActive           Boolean             @default(true)
  isSuperAdmin       Boolean             @default(false)
  isTempPassword     Boolean             @default(false)
  address            String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  
  // ê´€ê³„
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  checklistInstances ChecklistInstance[]
  favorites          Favorite[]
  inventoryChecks    InventoryCheck[]
  notices            Notice[]
  purchaseRequests   PurchaseRequest[]
  purchasedItems     PurchaseRequestItem[]
  lockedTimeSlots    TimeSlotChecklistStatus[]
  
  @@unique([tenantId, employeeId]) // í…Œë„ŒíŠ¸ ë‚´ì—ì„œë§Œ ê³ ìœ 
  @@index([tenantId, isActive])
}

// ========================================
// ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì‹œìŠ¤í…œ
// ========================================

model ChecklistTemplate {
  id                  String                         @id @default(cuid())
  tenantId            String                         // ğŸ”‘ í…Œë„ŒíŠ¸ ê²©ë¦¬
  content             String
  inputter            String
  inputDate           DateTime                       @default(now())
  workplace           Workplace
  category            Category
  timeSlot            TimeSlot
  isActive            Boolean                        @default(true)
  name                String                         @default("")
  autoGenerateEnabled Boolean                        @default(false)
  generationTime      String?
  recurrenceDays      Int[]                          @default([])
  createdAt           DateTime                       @default(now())
  updatedAt           DateTime                       @updatedAt
  
  // ê´€ê³„
  tenant              Tenant                         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  instances           ChecklistInstance[]
  items               ChecklistItem[]
  tagRelations        ChecklistTemplateTagRelation[]
  tags                Tag[]                          @relation("ChecklistTemplateTags")
  
  @@index([tenantId, isActive])
  @@index([tenantId, workplace, timeSlot])
}

model ChecklistInstance {
  id                      String                  @id @default(cuid())
  tenantId                String                  // ğŸ”‘ í…Œë„ŒíŠ¸ ê²©ë¦¬
  employeeId              String?
  templateId              String
  date                    DateTime
  workplace               Workplace
  timeSlot                TimeSlot
  isCompleted             Boolean                 @default(false)
  isSubmitted             Boolean                 @default(false)
  submittedAt             DateTime?
  isReopened              Boolean                 @default(false)
  reopenedAt              DateTime?
  reopenedBy              String?
  reopenReason            String?
  notes                   String?
  completedAt             DateTime?
  completedBy             String?
  itemProgress            Json?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  
  // ê´€ê³„
  tenant                  Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee                Employee?               @relation(fields: [employeeId], references: [id])
  template                ChecklistTemplate       @relation(fields: [templateId], references: [id], onDelete: Cascade)
  checklistItemProgresses ChecklistItemProgress[] @relation("ChecklistInstanceProgress")
  connectedItemsProgress  ConnectedItemProgress[]
  
  @@unique([tenantId, templateId, date]) // í…Œë„ŒíŠ¸ë³„ë¡œ í…œí”Œë¦¿-ë‚ ì§œ ì¡°í•© ê³ ìœ 
  @@index([tenantId, date])
  @@index([tenantId, workplace, timeSlot])
}

model ChecklistItem {
  id             String                    @id @default(cuid())
  templateId     String
  parentId       String?
  type           String
  content        String
  instructions   String?
  order          Int                       @default(0)
  isRequired     Boolean                   @default(true)
  isActive       Boolean                   @default(true)
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  
  // ê´€ê³„
  parent         ChecklistItem?            @relation("ParentChild", fields: [parentId], references: [id], onDelete: Cascade)
  children       ChecklistItem[]           @relation("ParentChild")
  template       ChecklistTemplate         @relation(fields: [templateId], references: [id], onDelete: Cascade)
  connectedItems ChecklistItemConnection[]
  progress       ChecklistItemProgress[]
}

model ChecklistItemProgress {
  id          String            @id @default(cuid())
  instanceId  String
  itemId      String
  isCompleted Boolean           @default(false)
  completedBy String?
  completedAt DateTime?
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  // ê´€ê³„
  instance    ChecklistInstance @relation("ChecklistInstanceProgress", fields: [instanceId], references: [id], onDelete: Cascade)
  item        ChecklistItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  @@unique([instanceId, itemId])
}

model ChecklistItemConnection {
  id              String        @id @default(cuid())
  checklistItemId String
  itemType        String
  itemId          String
  order           Int           @default(0)
  createdAt       DateTime      @default(now())
  
  // ê´€ê³„
  checklistItem   ChecklistItem @relation(fields: [checklistItemId], references: [id], onDelete: Cascade)
  
  @@unique([checklistItemId, itemType, itemId])
}

model ConnectedItemProgress {
  id           String            @id @default(cuid())
  instanceId   String
  itemId       String
  currentStock Int?
  updatedStock Int?
  isCompleted  Boolean           @default(false)
  notes        String?
  completedAt  DateTime?
  completedBy  String?
  connectionId String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  
  // ê´€ê³„
  instance     ChecklistInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

// ========================================
// ğŸ“¦ ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ
// ========================================

model InventoryItem {
  id            String                     @id @default(cuid())
  tenantId      String                     // ğŸ”‘ í…Œë„ŒíŠ¸ ê²©ë¦¬
  name          String
  category      Category
  currentStock  Float
  minStock      Float
  unit          String
  supplier      String?
  lastUpdated   DateTime                   @default(now())
  lastCheckedBy String?
  isActive      Boolean                    @default(true)
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt
  
  // ê´€ê³„
  tenant        Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  checks        InventoryCheck[]
  tagRelations  InventoryItemTagRelation[]
  purchaseItems PurchaseRequestItem[]
  tags          Tag[]                      @relation("InventoryItemTags")
  
  @@index([tenantId, isActive, lastUpdated])
  @@index([tenantId, category])
}

model InventoryCheck {
  id                   String        @id @default(cuid())
  itemId               String
  checkedBy            String
  checkedAt            DateTime      @default(now())
  currentStock         Float
  notes                String?
  needsRestock         Boolean       @default(false)
  estimatedRestockDate DateTime?
  
  // ê´€ê³„
  employee             Employee      @relation(fields: [checkedBy], references: [id])
  item                 InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  @@index([itemId, checkedAt])
}

// ========================================
// ğŸ›’ êµ¬ë§¤ ìš”ì²­ ì‹œìŠ¤í…œ
// ========================================

model PurchaseRequest {
  id            String                @id @default(cuid())
  tenantId      String                // ğŸ”‘ í…Œë„ŒíŠ¸ ê²©ë¦¬
  requestedBy   String
  requestedAt   DateTime              @default(now())
  status        PurchaseStatus        @default(PENDING)
  priority      PurchasePriority      @default(MEDIUM)
  estimatedCost Float?
  notes         String?
  approvedBy    String?
  approvedAt    DateTime?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  
  // ê´€ê³„
  tenant        Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee      Employee              @relation(fields: [requestedBy], references: [id])
  items         PurchaseRequestItem[]
  
  @@index([tenantId, status, priority, requestedAt])
}

model PurchaseRequestItem {
  id                String          @id @default(cuid())
  purchaseRequestId String
  itemId            String
  quantity          Float
  unitPrice         Float?
  notes             String?
  purchasedBy       String?
  purchasedAt       DateTime?
  receivedAt        DateTime?
  
  // ê´€ê³„
  item              InventoryItem   @relation(fields: [itemId], references: [id])
  request           PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)
  employee          Employee?       @relation(fields: [purchasedBy], references: [id])
}

// ========================================
// ğŸ·ï¸ íƒœê·¸ ì‹œìŠ¤í…œ
// ========================================

model Tag {
  id                         String                         @id @default(cuid())
  tenantId                   String                         // ğŸ”‘ í…Œë„ŒíŠ¸ ê²©ë¦¬
  name                       String
  color                      String?
  createdAt                  DateTime                       @default(now())
  
  // ê´€ê³„
  tenant                     Tenant                         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  checklistTemplateRelations ChecklistTemplateTagRelation[]
  inventoryItemRelations     InventoryItemTagRelation[]
  manualRelations            ManualTagRelation[]
  precautionRelations        PrecautionTagRelation[]
  checklistTemplates         ChecklistTemplate[]            @relation("ChecklistTemplateTags")
  inventoryItems             InventoryItem[]                @relation("InventoryItemTags")
  manuals                    Manual[]                       @relation("ManualTags")
  precautions                Precaution[]                   @relation("PrecautionTags")
  
  @@unique([tenantId, name]) // í…Œë„ŒíŠ¸ ë‚´ì—ì„œë§Œ íƒœê·¸ëª… ê³ ìœ 
  @@index([tenantId])
}

// íƒœê·¸ ê´€ê³„ í…Œì´ë¸”ë“¤
model ChecklistTemplateTagRelation {
  id         String            @id @default(cuid())
  templateId String
  tagId      String
  createdAt  DateTime          @default(now())
  
  tag        Tag               @relation(fields: [tagId], references: [id], onDelete: Cascade)
  template   ChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  @@unique([templateId, tagId])
}

model InventoryItemTagRelation {
  id        String        @id @default(cuid())
  itemId    String
  tagId     String
  createdAt DateTime      @default(now())
  
  item      InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  tag       Tag           @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([itemId, tagId])
}

model PrecautionTagRelation {
  id           String     @id @default(cuid())
  precautionId String
  tagId        String
  createdAt    DateTime   @default(now())
  
  precaution   Precaution @relation(fields: [precautionId], references: [id], onDelete: Cascade)
  tag          Tag        @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([precautionId, tagId])
}

model ManualTagRelation {
  id        String   @id @default(cuid())
  manualId  String
  tagId     String
  createdAt DateTime @default(now())
  
  manual    Manual   @relation(fields: [manualId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([manualId, tagId])
}

// ========================================
// ğŸ“– ë§¤ë‰´ì–¼ ë° ì£¼ì˜ì‚¬í•­
// ========================================

model Manual {
  id                  String                     @id @default(cuid())
  tenantId            String                     // ğŸ”‘ í…Œë„ŒíŠ¸ ê²©ë¦¬
  title               String
  content             String
  mediaUrls           String[]
  workplace           Workplace
  timeSlot            TimeSlot
  category            Category
  version             String                     @default("1.0")
  isActive            Boolean                    @default(true)
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  
  // ê´€ê³„
  tenant              Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  precautionRelations ManualPrecautionRelation[]
  tagRelations        ManualTagRelation[]
  precautions         Precaution[]               @relation("ManualPrecautions")
  tags                Tag[]                      @relation("ManualTags")
  
  @@index([tenantId, isActive])
  @@index([tenantId, workplace, category])
}

model Precaution {
  id              String                     @id @default(cuid())
  tenantId        String                     // ğŸ”‘ í…Œë„ŒíŠ¸ ê²©ë¦¬
  title           String
  content         String
  workplace       Workplace
  timeSlot        TimeSlot
  priority        Int                        @default(1)
  isActive        Boolean                    @default(true)
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime                   @updatedAt
  
  // ê´€ê³„
  tenant          Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  manualRelations ManualPrecautionRelation[]
  tagRelations    PrecautionTagRelation[]
  manuals         Manual[]                   @relation("ManualPrecautions")
  tags            Tag[]                      @relation("PrecautionTags")
  
  @@index([tenantId, isActive])
  @@index([tenantId, workplace, priority])
}

model ManualPrecautionRelation {
  id           String     @id @default(cuid())
  manualId     String
  precautionId String
  order        Int        @default(0)
  createdAt    DateTime   @default(now())
  
  manual       Manual     @relation(fields: [manualId], references: [id], onDelete: Cascade)
  precaution   Precaution @relation(fields: [precautionId], references: [id], onDelete: Cascade)
  
  @@unique([manualId, precautionId])
}

// ========================================
// ğŸ“¢ ê³µì§€ì‚¬í•­ ë° ê¸°íƒ€
// ========================================

model Notice {
  id        String   @id @default(cuid())
  tenantId  String   // ğŸ”‘ í…Œë„ŒíŠ¸ ê²©ë¦¬
  title     String
  content   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  
  // ê´€ê³„
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  author    Employee @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  
  @@index([tenantId, isActive, createdAt])
}

model Favorite {
  id         String         @id @default(cuid())
  tenantId   String         // ğŸ”‘ í…Œë„ŒíŠ¸ ê²©ë¦¬
  employeeId String
  targetType FavoriteTarget
  targetId   String
  createdAt  DateTime       @default(now())
  
  // ê´€ê³„
  tenant     Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee   Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, employeeId, targetType, targetId])
  @@index([tenantId, employeeId, targetType])
}

model TimeSlotChecklistStatus {
  id        String    @id @default(cuid())
  date      DateTime  @db.Date
  workplace Workplace
  timeSlot  TimeSlot
  lockedBy  String?
  status    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  // ê´€ê³„
  employee  Employee? @relation(fields: [lockedBy], references: [id])
  
  @@unique([date, timeSlot, workplace])
}

model PosReport {
  id               String   @id @default(cuid())
  tenantId         String   // ğŸ”‘ í…Œë„ŒíŠ¸ ê²©ë¦¬
  filename         String
  originalFilename String
  recordCount      Int
  uploadDate       DateTime @default(now())
  uploadedBy       String
  data             Json
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // ê´€ê³„
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, uploadDate])
}

// ========================================
// ğŸ“Š Enum ì •ì˜
// ========================================

enum SubscriptionTier {
  FREE        // ë¬´ë£Œ (ì œí•œëœ ê¸°ëŠ¥)
  PRO         // í”„ë¡œ (ì›” êµ¬ë…)
  ENTERPRISE  // ì—”í„°í”„ë¼ì´ì¦ˆ (ì—° êµ¬ë…)
}

enum Workplace {
  HALL      // í™€
  KITCHEN   // ì£¼ë°©
  COMMON    // ê³µí†µ
}

enum Category {
  CHECKLIST    // ì²´í¬ë¦¬ìŠ¤íŠ¸
  PRECAUTIONS  // ì£¼ì˜ì‚¬í•­
  HYGIENE      // ìœ„ìƒ
  SUPPLIES     // ìš©í’ˆ
  INGREDIENTS  // ì¬ë£Œ
  COMMON       // ê³µí†µ
  MANUAL       // ë§¤ë‰´ì–¼
}

enum TimeSlot {
  PREPARATION  // ì¤€ë¹„ (ì˜¤í”ˆ ì „)
  IN_PROGRESS  // ìš´ì˜ ì¤‘
  CLOSING      // ë§ˆê°
  COMMON       // ê³µí†µ
}

enum PurchaseStatus {
  PENDING    // ëŒ€ê¸°
  APPROVED   // ìŠ¹ì¸
  REJECTED   // ê±°ì ˆ
  PURCHASED  // êµ¬ë§¤ì™„ë£Œ
  RECEIVED   // ì…ê³ ì™„ë£Œ
}

enum PurchasePriority {
  LOW     // ë‚®ìŒ
  MEDIUM  // ë³´í†µ
  HIGH    // ë†’ìŒ
  URGENT  // ê¸´ê¸‰
}

enum FavoriteTarget {
  MANUAL      // ë§¤ë‰´ì–¼
  PRECAUTION  // ì£¼ì˜ì‚¬í•­
}